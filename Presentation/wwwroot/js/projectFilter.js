/**
 * Project Filtering System
 * - Most of the code has been generated by Gemini AI
 * Handles real-time filtering of project cards based on search input
 * This file implements the search functionality for the projects page
 * Allows filtering by project name, client name, and other project attributes
 */

// Main filtering function that gets called when search input changes
function filterProjects(query) {
  // Normalize query for case-insensitive search
  query = query.toLowerCase().trim();

  // Get all project cards in the grid
  const projectCards = document.querySelectorAll(".project-grid .project-card");

  projectCards.forEach((card) => {
    // Get searchable content from the card
    const projectName =
      card.querySelector(".project-name")?.textContent?.toLowerCase() || "";
    const clientName =
      card.querySelector(".client-name")?.textContent?.toLowerCase() || "";
    const description =
      card.querySelector(".project-description")?.textContent?.toLowerCase() ||
      "";
    const status =
      card.querySelector(".project-status")?.textContent?.toLowerCase() || "";

    // Combine all searchable content
    const searchableContent = `${projectName} ${clientName} ${description} ${status}`;

    // Show/hide card based on whether it matches the search query
    if (searchableContent.includes(query)) {
      card.style.display = "block";
      // Add fade-in animation for smooth UX
      card.style.opacity = "1";
      card.style.transform = "scale(1)";
    } else {
      // Add fade-out animation
      card.style.opacity = "0";
      card.style.transform = "scale(0.8)";
      setTimeout(() => {
        card.style.display = "none";
      }, 300); // Match this with CSS transition duration
    }
  });

  // Update empty state message
  updateEmptyState(projectCards, query);
}

// Function to show/hide empty state message when no results are found
function updateEmptyState(projectCards, query) {
  // Check if any cards are visible
  const visibleCards = Array.from(projectCards).some(
    (card) => card.style.display !== "none"
  );

  // Get or create empty state message element
  let emptyState = document.querySelector(".empty-state-message");
  if (!emptyState) {
    emptyState = document.createElement("div");
    emptyState.className = "empty-state-message text-center mt-4";
    document.querySelector(".project-grid").appendChild(emptyState);
  }

  // Update empty state message
  if (!visibleCards) {
    emptyState.textContent = `No projects found matching "${query}"`;
    emptyState.style.display = "block";
  } else {
    emptyState.style.display = "none";
  }
}

// Initialize filtering system when DOM is loaded
document.addEventListener("DOMContentLoaded", function () {
  // Get search input element
  const searchInput = document.querySelector(".search-input");

  if (searchInput) {
    // Add input event listener for real-time filtering
    searchInput.addEventListener("input", function () {
      filterProjects(this.value);
    });

    // Add clear button functionality if present
    const clearButton =
      searchInput.parentElement.querySelector(".clear-search");
    if (clearButton) {
      clearButton.addEventListener("click", function () {
        searchInput.value = "";
        filterProjects("");
      });
    }
  }
});

/**
 * Project filtering functionality for status tabs
 */
document.addEventListener("DOMContentLoaded", function () {
  // Get all filter tabs and project cards
  const filterTabs = document.querySelectorAll(".filter-tab");
  const projectCards = document.querySelectorAll(".project-card");

  // Add click event to each filter tab
  filterTabs.forEach((tab) => {
    tab.addEventListener("click", function (e) {
      e.preventDefault();

      // Remove active class from all tabs
      filterTabs.forEach((t) => t.classList.remove("active"));

      // Add active class to clicked tab
      this.classList.add("active");

      // Get the status to filter by
      const statusFilter = this.getAttribute("data-status");

      // Show/hide project cards based on status with animation
      let visibleCount = 0;
      projectCards.forEach((card) => {
        const cardStatus = card.getAttribute("data-status");

        if (statusFilter === "all" || statusFilter === cardStatus) {
          // Show the card with animation
          card.style.opacity = "0";
          card.style.transform = "translateY(10px)";
          card.style.display = "";
          visibleCount++;

          // Use setTimeout to create a staggered animation effect
          setTimeout(() => {
            card.style.opacity = "1";
            card.style.transform = "translateY(0)";
          }, 50);
        } else {
          // Hide the card
          card.style.opacity = "0";
          card.style.transform = "translateY(10px)";

          // Wait for animation to complete before hiding
          setTimeout(() => {
            card.style.display = "none";
          }, 300);
        }
      });

      // Show/hide the "no filtered projects" message
      const noFilteredProjects = document.querySelector(
        ".no-filtered-projects"
      );
      if (noFilteredProjects) {
        if (visibleCount === 0 && projectCards.length > 0) {
          // We have projects but none match the filter
          setTimeout(() => {
            noFilteredProjects.style.display = "block";
            noFilteredProjects.style.opacity = "0";
            noFilteredProjects.style.transform = "translateY(10px)";

            setTimeout(() => {
              noFilteredProjects.style.opacity = "1";
              noFilteredProjects.style.transform = "translateY(0)";
            }, 50);
          }, 300);
        } else {
          noFilteredProjects.style.display = "none";
        }
      }

      // Update the URL with the selected filter (without page reload)
      const url = new URL(window.location.href);
      if (statusFilter === "all") {
        url.searchParams.delete("status");
      } else {
        url.searchParams.set("status", statusFilter);
      }
      window.history.pushState({}, "", url);
    });
  });

  // Check if there's a status filter in the URL on page load
  const urlParams = new URLSearchParams(window.location.search);
  const statusParam = urlParams.get("status");

  if (statusParam) {
    // Find the tab with the matching status and click it
    const matchingTab = document.querySelector(
      `.filter-tab[data-status="${statusParam}"]`
    );
    if (matchingTab) {
      matchingTab.click();
    }
  } else {
    // If no filter in URL, ensure all cards are visible with animation
    projectCards.forEach((card, index) => {
      // Set initial state
      card.style.opacity = "0";
      card.style.transform = "translateY(10px)";

      // Stagger the animations
      setTimeout(() => {
        card.style.opacity = "1";
        card.style.transform = "translateY(0)";
      }, 50 * index); // Stagger based on index
    });
  }

  // Log for debugging
  console.log(
    `Found ${filterTabs.length} filter tabs and ${projectCards.length} project cards`
  );
});
